version: "1.0"

metadata:
  name: "vqvae_baseline_10k"
  description: |
    Minimal IC basis dataset optimized for VQ-VAE training.
    Equal-weighted (25% each): Gaussian noise, band-limited noise, sinusoids, localized blobs.
    Designed to minimize IC bias and maximize operator regime learning.
  author: "Spinlock Team"
  created: "2025-12-29"
  purpose: |
    Force VQ-VAE to learn discrete operator equivalence classes under reconstruction pressure.
    Avoids semantic IC structure. Focuses on operator dynamics.

    Minimal IC basis:
    - Gaussian white noise (5 discrete variance levels: 0.25, 0.5, 1.0, 2.0, 4.0)
    - Band-limited noise (3 frequency bands: low/mid/high, strictly isolated)
    - Single-mode sinusoids (pure stripe patterns)
    - Localized Gaussian blobs/impulses

    Design principles:
    - Equal weights (25% per IC family) to eliminate IC bias
    - Discrete variance regimes (not continuous)
    - Strict spectral isolation (minimal band leakage)
    - Operator effects dominant (IC as probe, not semantic structure)

# 14-dimensional parameter space (same as 50k_max_stratified for consistency)
parameter_space:
  architecture:
    num_layers:
      type: integer
      bounds: [2, 5]
      description: "Number of convolutional layers"

    base_channels:
      type: integer
      bounds: [16, 64]
      description: "Base number of channels"

    kernel_size:
      type: choice
      choices: [3, 5, 7]
      description: "Kernel size for convolutions"

    activation:
      type: choice
      choices: ["gelu"]
      description: "Activation function (Gaussian Error Linear Unit)"

    dropout_rate:
      type: continuous
      bounds: [0.0, 0.3]
      description: "Dropout probability"

  stochastic:
    noise_type:
      type: choice
      choices: ["gaussian"]
      description: "Stochastic noise distribution (Gaussian)"

    noise_scale:
      type: continuous
      bounds: [0.00001, 1.0]
      log_scale: true
      description: "Scale of stochastic perturbations"

    noise_schedule:
      type: choice
      choices: ["constant"]
      description: "Temporal noise schedule (constant throughout rollout)"

    spatial_correlation:
      type: continuous
      bounds: [0.0, 0.3]
      description: "Spatial correlation length for noise"

  operator:
    normalization:
      type: choice
      choices: ["instance"]
      description: "Feature normalization (instance norm for numerical stability)"

    grid_size:
      type: choice
      choices: [128]
      description: "Spatial grid resolution (fixed at 128×128)"

  evolution:
    update_policy:
      type: choice
      choices: ["residual"]
      description: "Temporal update policy (Euler integration)"

      # WEIGHTED CHOICE EXAMPLE:
      # To stratify across multiple update policies with non-uniform proportions,
      # use the weights field (must sum to 1.0):
      #
      # choices: ["residual", "convex", "autoregressive"]
      # weights: [0.5, 0.3, 0.2]  # 50% residual, 30% convex, 20% autoregressive
      #
      # If weights are omitted, uniform distribution is used (33.3% each for 3 choices).

    alpha:
      type: continuous
      bounds: [0.1, 0.9]
      description: "Convex policy mixing parameter"

    dt:
      type: continuous
      bounds: [0.001, 0.1]
      log_scale: true
      description: "Residual policy step size"

# Sampling configuration
sampling:
  strategy: "sobol_stratified"

  sobol:
    scramble: true
    seed: 42

  stratification:
    method: "adaptive"
    num_strata_per_dim: 3
    min_samples_per_stratum: 10

  validation:
    check_discrepancy: true
    check_correlation: true

  total_samples: 10000
  batch_size: 100

# Simulation with minimal IC basis (4 families, 25% each)
simulation:
  device: "cuda"

  parallelism:
    strategy: "data_parallel"
    devices: "auto"

  input_generation:
    method: "sampled"

    # Equal weighting: 25% per IC family
    # Total IC types: 10 (5 Gaussian variants + 3 band variants + 1 structured + 1 localized)
    ic_type_weights:
      # Gaussian noise family (25% total, split across 5 variance levels)
      # Each variance level gets 5% (0.05)
      gaussian_random_field_v0: 0.05   # variance=0.25
      gaussian_random_field_v1: 0.05   # variance=0.5
      gaussian_random_field_v2: 0.05   # variance=1.0
      gaussian_random_field_v3: 0.05   # variance=2.0
      gaussian_random_field_v4: 0.05   # variance=4.0

      # Band-limited noise family (25% total, 8.33% per band)
      multiscale_grf_low: 0.0833       # Low frequency
      multiscale_grf_mid: 0.0833       # Mid frequency
      multiscale_grf_high: 0.0834      # High frequency (extra 0.0001 for rounding)

      # Sinusoid family (25%)
      structured: 0.25

      # Localized blob family (25%)
      localized: 0.25

    # =================================================================
    # IC-Specific Configurations
    # =================================================================

    # Gaussian noise: 5 discrete variance levels (log-spaced)
    # Note: Uses near-white noise (length_scale=0.05) to minimize spatial correlation
    gaussian_random_field_v0:
      length_scale: 0.05  # Near white noise
      variance: 0.25      # Low amplitude regime

    gaussian_random_field_v1:
      length_scale: 0.05
      variance: 0.5       # Medium-low amplitude regime

    gaussian_random_field_v2:
      length_scale: 0.05
      variance: 1.0       # Standard amplitude regime (baseline)

    gaussian_random_field_v3:
      length_scale: 0.05
      variance: 2.0       # Medium-high amplitude regime

    gaussian_random_field_v4:
      length_scale: 0.05
      variance: 4.0       # High amplitude regime

    # Band-limited noise: 3 frequency bands with strict isolation
    # Low frequency: Long correlation lengths (large-scale structure)
    multiscale_grf_low:
      scales: [0.30, 0.35, 0.40]  # Long correlation (low frequency)
      variance: 1.0                # Energy-normalized

    # Mid frequency: Medium correlation lengths (intermediate-scale structure)
    multiscale_grf_mid:
      scales: [0.08, 0.10, 0.12]  # Medium correlation (mid frequency)
      variance: 1.0                # Energy-normalized

    # High frequency: Short correlation lengths (fine-scale structure)
    multiscale_grf_high:
      scales: [0.02, 0.03, 0.04]  # Short correlation (high frequency)
      variance: 1.0                # Energy-normalized

    # Sinusoids: Pure stripe patterns (no circles/blobs)
    # Note: Frequency/amplitude are hardcoded in generator (freq ~ [1,6], amp ~ N(0,1))
    structured:
      num_structures: 3                    # Reduced for cleaner patterns
      structure_types: ["stripe"]          # Sinusoids only (no circles, no blobs)

    # Localized blobs: Gaussian impulses
    # Width range: 5-15 pixels (localized features)
    localized:
      num_blobs: 5                         # 5 blobs per field
      min_width: 5.0                       # Minimum blob width (pixels)
      max_width: 15.0                      # Maximum blob width (pixels)

  precision: "float32"

  num_realizations: 5

# Dataset generation configuration
dataset:
  output_path: "./datasets/vqvae_baseline_10k.h5"

  storage:
    backend: "hdf5"
    compression: "gzip"
    compression_level: 4
    chunk_size: 100

logging:
  level: "INFO"

# =============================================================================
# VQ-VAE Training Objectives
# =============================================================================
#
# This dataset is designed specifically for VQ-VAE codebook learning with:
#
# 1. Operator-Centric Tokens:
#    - Tokens encode: diffusion strength, wave speed, nonlinearity, stability
#    - NOT: IC type, semantic structure, domain-specific features
#    - Reconstruction pressure drives operator equivalence class discovery
#
# 2. Minimal IC Bias:
#    - Equal weights (25% per IC family) → uniform IC distribution
#    - Low mutual information I(token_id; IC_type)
#    - Tokens forced to explain variance within IC families (operator effects)
#    - No "easy clustering" by IC type
#
# 3. Regime Identification:
#    - Gaussian noise: 5 discrete amplitude regimes (0.25, 0.5, 1.0, 2.0, 4.0)
#    - Band-limited: 3 frequency regimes (low/mid/high, strictly isolated)
#    - Controlled study: "How does operator X respond to amplitude/frequency?"
#
# 4. Spectral Isolation:
#    - Low-freq band: Tests diffusion-like operators (suppress high-freq)
#    - Mid-freq band: Tests wave propagation (selective frequency response)
#    - High-freq band: Tests fine structure enhancement (sharpen edges)
#    - Strict bands → clean operator signatures → clear token assignments
#
# 5. Codebook Quality:
#    - Reusable across IC distributions (neutral prior)
#    - Operator-centric embeddings
#    - Transferable to new IC types (domain shift robustness)
#    - Ablation-ready: swap IC distributions without retraining
#
# =============================================================================
# Expected Results
# =============================================================================
#
# Dataset Statistics:
# - Total samples: 10,000 operators
# - Total trajectories: 50,000 (10k × 5 realizations)
# - Shape: [10000, 5, 1, 3, 128, 128] (N, M, T, C, H, W)
# - Size: ~6-7 GB (with gzip compression)
#
# IC Distribution (Expected):
# - Gaussian noise (all variances): 25.0% ± 2%
# - Band-limited (all bands): 25.0% ± 2%
# - Sinusoids: 25.0% ± 2%
# - Localized blobs: 25.0% ± 2%
#
# Gaussian Variance Stratification (Expected):
# - variance=0.25: 5.0% ± 1%
# - variance=0.5: 5.0% ± 1%
# - variance=1.0: 5.0% ± 1%
# - variance=2.0: 5.0% ± 1%
# - variance=4.0: 5.0% ± 1%
#
# Spectral Band Distribution (Expected):
# - Low frequency: 8.33% ± 1%
# - Mid frequency: 8.33% ± 1%
# - High frequency: 8.34% ± 1%
#
# VQ-VAE Codebook Properties (Target):
# - Token usage NOT clustered by IC type
# - Reconstruction error correlates with operator complexity, not IC type
# - Tokens transfer across IC distributions
# - Ablation studies show IC-invariant token usage
#
# =============================================================================
# Validation Steps (Post-Generation)
# =============================================================================
#
# 1. IC Distribution Check:
#    - Verify 25% ± 2% for each IC family
#    - Verify 5% ± 1% for each Gaussian variance level
#    - Verify 8.33% ± 1% for each frequency band
#
# 2. Spectral Isolation Check:
#    - Compute power spectrum for each band
#    - Verify <5% energy leakage between bands
#    - Verify energy normalization (mean power ≈ 1.0 per band)
#
# 3. Energy Normalization Check:
#    - All bands: mean(L2 norm) ≈ 1.0 ± 0.1
#    - All variance levels: mean(L2 norm) ∝ sqrt(variance)
#
# 4. Operator Diversity Check:
#    - Parameter space coverage (Sobol discrepancy < 0.05)
#    - Operator output diversity (pairwise similarity matrix)
#
# Use: scripts/validation/validate_ic_distribution.py
#
# =============================================================================
