version: "1.0"

metadata:
  name: "lambda_labs_test_10"
  description: |
    Minimal 10-operator test dataset for Lambda Labs infrastructure validation.
    Based on baseline_10k config with reduced scale for rapid testing.
    Uses Lambda Labs built-in file storage (no S3 dependency).
    Quick runtime: ~2-3 minutes total.
  author: "Spinlock Team"
  created: "2026-01-02"
  purpose: |
    Test Lambda Labs cloud infrastructure before running large-scale generation:
    - Verify API key and authentication
    - Test SSH connectivity and job submission
    - Validate dataset generation and feature extraction
    - Confirm file download from Lambda Labs instance

    Runtime: 2-3 minutes for 10 operators × 5 realizations × 100 timesteps
    Cost: ~$0.02 (negligible)

# Same 14-dimensional parameter space as baseline_10k
parameter_space:
  architecture:
    num_layers:
      type: integer
      bounds: [2, 5]

    base_channels:
      type: integer
      bounds: [16, 64]

    kernel_size:
      type: choice
      choices: [3, 5, 7]

    activation:
      type: choice
      choices: ["gelu"]

    dropout_rate:
      type: continuous
      bounds: [0.0, 0.3]

  stochastic:
    noise_type:
      type: choice
      choices: ["gaussian"]

    noise_scale:
      type: continuous
      bounds: [0.00001, 1.0]
      log_scale: true

    noise_schedule:
      type: choice
      choices: ["constant"]

    spatial_correlation:
      type: continuous
      bounds: [0.0, 0.3]

  operator:
    normalization:
      type: choice
      choices: ["instance"]

    grid_size:
      type: choice
      choices: [128]

  evolution:
    update_policy:
      type: choice
      choices: ["residual", "convex"]
      weights: [0.75, 0.25]

# Minimal sampling configuration
sampling:
  strategy: "sobol_stratified"

  sobol:
    scramble: true
    seed: 42

  stratification:
    method: "adaptive"
    num_strata_per_dim: 2  # Minimal stratification for 10 samples
    min_samples_per_stratum: 1

  validation:
    check_discrepancy: true
    check_correlation: true

  total_samples: 2  # Just 2 operators for quick testing
  batch_size: 2  # Same as baseline (validated)

# Simulation with full IC basis (same as baseline_10k)
simulation:
  device: "cuda"

  parallelism:
    strategy: "data_parallel"
    devices: "auto"

  input_generation:
    method: "sampled"

    # Equal weighting: 25% per IC family (same as baseline_10k)
    ic_type_weights:
      # Gaussian noise family (25% total, split across 5 variance levels)
      gaussian_random_field_v0: 0.05   # variance=0.25
      gaussian_random_field_v1: 0.05   # variance=0.5
      gaussian_random_field_v2: 0.05   # variance=1.0
      gaussian_random_field_v3: 0.05   # variance=2.0
      gaussian_random_field_v4: 0.05   # variance=4.0

      # Band-limited noise family (25% total)
      multiscale_grf_low: 0.0833
      multiscale_grf_mid: 0.0833
      multiscale_grf_high: 0.0834

      # Sinusoid family (25%)
      structured: 0.25

      # Localized blob family (25%)
      localized: 0.25

    # IC-specific configurations (same as baseline_10k)
    gaussian_random_field_v0:
      length_scale: 0.05
      variance: 0.25

    gaussian_random_field_v1:
      length_scale: 0.05
      variance: 0.5

    gaussian_random_field_v2:
      length_scale: 0.05
      variance: 1.0

    gaussian_random_field_v3:
      length_scale: 0.05
      variance: 2.0

    gaussian_random_field_v4:
      length_scale: 0.05
      variance: 4.0

    multiscale_grf_low:
      scales: [0.30, 0.35, 0.40]
      variance: 1.0

    multiscale_grf_mid:
      scales: [0.08, 0.10, 0.12]
      variance: 1.0

    multiscale_grf_high:
      scales: [0.02, 0.03, 0.04]
      variance: 1.0

    structured:
      num_structures: 3
      structure_types: ["stripe"]

    localized:
      num_blobs: 5
      min_width: 5.0
      max_width: 15.0

  precision: "float16"  # Same as baseline

  num_realizations: 5  # Full 5 for testing (can reduce to 3 like baseline if needed)
  num_timesteps: 100  # Reduced for local testing (will be 500 on Lambda Labs A100)

  # Operator feature extraction disabled (same as baseline - redundant with temporal features)
  extract_operator_features: false

# Dataset output configuration
dataset:
  output_path: "lambda_labs_test_10.h5"

  storage:
    backend: "hdf5"
    compression: "gzip"
    compression_level: 4
    chunk_size: 2  # Must be <= total_samples (2 for quick testing)

    # Feature-only mode (same as baseline)
    store_trajectories: false

# Cloud configuration - Lambda Labs with built-in file storage
cloud:
  provider:
    enabled: true
    provider: "lambda_labs"

  lambda_labs:
    api_key: "${LAMBDA_API_KEY}"  # Loaded from environment
    gpu_type: "A100"
    instance_type: "gpu_1x_a100_sxm4"
    region: "us-west-1"
    ssh_key_name: "spinlock-key"

    # Safety limits
    max_cost_per_hour: 1.50
    auto_shutdown_on_completion: true

    # Remote execution
    remote_working_dir: "/home/ubuntu/spinlock"

  # Use Lambda Labs built-in file storage (NOT S3)
  lambda_labs_storage:
    remote_path: "/home/ubuntu/datasets"  # Where dataset is saved on Lambda instance
    local_download_path: "datasets/"      # Download to local datasets/ directory after generation

# Logging
logging:
  level: "INFO"

# =============================================================================
# Expected Results
# =============================================================================
#
# Scale:
# - 10 operators × 5 realizations = 50 total samples
# - 128×128 spatial resolution
# - 100 timesteps per trajectory (500 on Lambda Labs)
# - Feature-only mode: ~5-10MB storage
#
# Runtime (local, 100 timesteps):
# - Generation: 1-2 minutes
# - Feature extraction: Inline (included in generation time)
# - Total: ~2-3 minutes end-to-end
#
# Runtime (Lambda Labs, 500 timesteps):
# - Generation: 3-5 minutes
# - Feature extraction: Inline
# - Download: <10 seconds (10MB file)
# - Total: ~5-10 minutes end-to-end
#
# Cost:
# - Lambda Labs A100: $1.10/hr
# - 5-10 minutes = ~$0.10-0.18
# - Negligible cost for testing
#
# Usage:
#   # Local test (100 timesteps)
#   poetry run spinlock cloud-generate \
#     --config configs/cloud/lambda_labs_test_10.yaml \
#     --provider local \
#     --monitor
#
#   # Lambda Labs test (will use 500 timesteps via override)
#   poetry run spinlock cloud-generate \
#     --config configs/cloud/lambda_labs_test_10.yaml \
#     --provider lambda_labs \
#     --monitor
#
# Validation:
#   # Check downloaded dataset
#   poetry run python -c "
#   import h5py
#   with h5py.File('datasets/lambda_labs_test_10.h5', 'r') as f:
#       print('Groups:', list(f.keys()))
#       if 'features' in f:
#           print('Feature groups:', list(f['features'].keys()))
#   "
#
# =============================================================================
